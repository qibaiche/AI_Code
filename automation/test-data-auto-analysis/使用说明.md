# Test Data Auto Analysis - 使用说明

> 📖 **自动化数据分析工具：自动从 SQLPathFinder 抓取数据，生成 Excel 报告并发送邮件**

## 📋 目录
- [快速开始](#快速开始)
- [功能说明](#功能说明)
- [配置说明](#配置说明)
- [运行方法](#运行方法)
- [输出说明](#输出说明)
- [常见问题](#常见问题)

---

## 🚀 快速开始

### 第一步：检查环境

1. **Python 3.8+**：命令行运行 `python --version` 检查
2. **SQLPathFinder**：已安装并可用
3. **Outlook**：已登录（如使用 outlook 模式）

### 第二步：准备文件

1. **LOT 列表**：编辑 `Lot info.txt`，每行一个 LOT：
   ```text
   P540451CR
   P540420CR
   ```

2. **VG2 文件**：确认存在
   - `Get_Sort_or_Test_Unit_Results_HBASE_By_Lot.VG2`
   - `Lab_Class_Data_Performance.VG2`

3. **Run 按钮截图**：`assets/run_button.png`（参考 `assets/如何截取Run按钮.md`）

### 第三步：配置路径

#### PRD LOT 配置 (`prd_lot_automation/config.yaml`)

**必须修改**：
```yaml
email:
  to:
    - "你的邮箱@intel.com"  # 👈 修改这里

paths:
  output_csv: "C:/Users/你的用户名/AppData/Local/Temp/SQLPathFinder_Temp/by_lot.csv"  # 👈 确认路径
  upgrade_script: "C:/Users/你的用户名/My Programs/SQLPathFinder3/StartSQLPathFinder.bat"  # 👈 可选
```

#### Lab TP 配置 (`lab_tp_automation/config.yaml`)

**必须修改**：
```yaml
email:
  to:
    - "你的邮箱@intel.com"  # 👈 修改这里

paths:
  output_csv: "C:/Users/你的用户名/AppData/Local/Temp/SQLPathFinder_Temp/Lot_Level_Data.csv"  # 👈 确认路径
```

### 第四步：安装依赖

```bash
python -m pip install -r prd_lot_automation\requirements.txt
```

### 第五步：测试运行

1. 编辑 `Lot info.txt`，只保留 1-2 个 LOT
2. 双击运行：`运行PRD_LOT.bat`
3. 检查 `reports` 文件夹和邮箱

---

## 🎯 功能说明

### PRD LOT 自动化

**功能**：生成 Bin Pareto 分析报告

**输出**：`Bin_Pareto_Report_YYYY-MM-DD.xlsx`
- 按 `process_step` 分组的 Pareto 表：
  - Functional_bin Pareto（FuncBin_classhot, FuncBin_classcold 等）
  - Interface_bin Pareto（IntfBin_classhot, IntfBin_classcold 等）
  - Retest Bin Pareto（RetestBin_classhot, RetestBin_classcold 等）
- Details（明细数据）
- Exceptions（异常数据）

**特殊功能**：
- Functional bin 100 和 Interface bin 1 始终为绿色
- 其他 bin 按百分比显示颜色（>5% 红色，2-5% 黄色，≤2% 绿色）
- 自动处理 SQLPathFinder 更新对话框

### Lab TP Performance 自动化

**功能**：生成 Lab TP Performance 报告

**输出**：`Lab_TP_Performance_YYYYMMDD.xlsx`
- Lot Level Performance 工作表
- 包含 LOT 信息（如果数据中有）
- 按 Sub Flow Step 排序：CLASSHOT, CLASSCOLD, PHMHOT, PHMCOLD, 其他
- 自动排除 SCS 数据
- 应用 PHI 条件格式

### 统一自动化

**功能**：同时运行两个自动化并发送统一邮件

**运行**：双击 `运行全部自动化.bat`

**输出**：
- 两个 Excel 报告
- 一封统一邮件（包含两个报告附件和 HTML 表格）

---

## ⚙️ 配置说明

### 配置文件位置

- PRD LOT：`prd_lot_automation/config.yaml`
- Lab TP：`lab_tp_automation/config.yaml`

### 主要配置项

#### 路径配置 (`paths`)
```yaml
lots_file: "../Lot info.txt"  # LOT 列表文件
vg2_file: "../Get_Sort_or_Test_Unit_Results_HBASE_By_Lot.VG2"  # VG2 脚本
output_csv: "..."  # ⚠️ CSV 输出路径（需确认）
upgrade_script: "..."  # 升级脚本路径（可选）
```

#### 邮件配置 (`email`)
```yaml
mode: "outlook"  # 或 "smtp"
to:
  - "你的邮箱@intel.com"  # ⚠️ 必须修改
cc: []  # 抄送人（可选）
subject_template: "[LOT日报] {date}（共{lot_count}个 LOT）"
```

#### 处理参数 (`processing`)
```yaml
percentage_thresholds:
  red: 0.05  # 红色：>5%
  yellow: 0.02  # 黄色：2-5%
max_lots_per_batch: null  # 分批处理：null=不分批，10=每批10个
filters:
  mut_within_subflow_latest_flag: "Y"
  SUBSTRUCTURE_ID: "U1.U2"
```

#### 字段映射 (`fields`)
```yaml
lot: "lot"
functional_bin: "functional_bin"
interface_bin: "interface_bin"
devrevstep: "devrevstep"
visual_id: "VISUAL_ID"
process_step: "process_step"
```

**注意**：如果 CSV 列名不同，需要修改字段映射

---

## 🚀 运行方法

### 方式一：PRD LOT 自动化
双击：`运行PRD_LOT.bat`

### 方式二：Lab TP Performance 自动化
双击：`lab_tp_automation\运行Lab_TP自动化.bat`

### 方式三：统一自动化（推荐）
双击：`运行全部自动化.bat`

---

## 📊 输出说明

### 报告文件
- `reports/Bin_Pareto_Report_YYYY-MM-DD.xlsx`：PRD LOT 报告
- `reports/Lab_TP_Performance_YYYYMMDD.xlsx`：Lab TP 报告

### 日志文件
- `logs/prd_lot_automation.log`
- `logs/lab_tp_automation.log`
- `logs/unified_automation.log`

### 邮件通知
- 自动发送邮件，包含报告附件
- 统一自动化邮件包含 HTML 表格（LOT 列在 Program Name 之后）

---

## ❓ 常见问题

### Q1: 找不到 Run 按钮
**解决**：检查 `assets/run_button.png` 是否存在，参考 `assets/如何截取Run按钮.md` 重新截取

### Q2: 无法连接 SQLPathFinder
**解决**：
1. 检查窗口标题是否为 "SQLPathFinder"（可在配置中修改）
2. 增加超时时间：`timeouts.spf_launch: 120`
3. 先手动打开 SQLPathFinder 再运行

### Q3: CSV 文件读取为空
**解决**：
1. 手动运行一次 VG2，确认 CSV 输出路径
2. 在配置文件中更新 `output_csv` 路径
3. 检查 LOT 列表和网络连接

### Q4: 邮件发送失败
**解决**：
- Outlook 模式：确认 Outlook 已登录，首次运行点击"允许"
- SMTP 模式：配置正确的 SMTP 信息

### Q5: 数据处理出错
**解决**：检查 CSV 列名，在配置文件中更新 `fields` 映射（区分大小写）

### Q6: 程序运行时间过长
**解决**：
1. 启用分批处理：`processing.max_lots_per_batch: 10`
2. 增加超时时间：`timeouts.overall_timeout: 1800`

### Q7: SQLPathFinder 更新对话框
**解决**：工具已自动处理，需配置 `paths.upgrade_script` 路径

### Q8: 报告生成失败
**解决**：
1. 关闭正在打开的 Excel 文件
2. 检查 `reports` 文件夹权限
3. 检查磁盘空间

---

## 📌 注意事项

⚠️ **重要**：
- 运行期间不要操作 SQLPathFinder 窗口
- 确保系统不会自动锁屏或休眠
- 首次运行建议使用少量 LOT 测试

✅ **最佳实践**：
- 定期清理 `logs` 和 `reports` 文件夹
- 定期备份配置文件

---

## ✅ 检查清单

使用前确认：
- [ ] Python 已安装
- [ ] SQLPathFinder 已安装
- [ ] Outlook 已登录
- [ ] `Lot info.txt` 已准备好
- [ ] VG2 文件存在
- [ ] `run_button.png` 存在
- [ ] 邮箱地址已修改（两个配置文件）
- [ ] CSV 输出路径已确认（两个配置文件）
- [ ] 依赖包已安装
- [ ] 已用少量 LOT 测试成功

---

## 📞 联系方式

**作者**：qibaiche (陈麒百)  
**邮箱**：qibai.chen@intel.com  
**部门**：CDG CD PDE

---

**版本**：v1.1.3  
**最后更新**：2025-12-17
