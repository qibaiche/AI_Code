# PRD LOT 自动化工具 - 使用说明

## 📋 目录
- [功能简介](#功能简介)
- [前置准备](#前置准备)
- [配置指南](#配置指南)
- [运行方法](#运行方法)
- [输出说明](#输出说明)
- [常见问题](#常见问题)

---

## 🎯 功能简介

本工具实现以下自动化流程：
1. 📖 读取 LOT 列表文件
2. 🚀 自动启动 SQLPathFinder 并执行 VG2 脚本
3. 📊 等待数据抓取完成
4. 📈 生成 Functional_bin × DevRevStep 的 Pareto 分析表
5. 📧 自动发送 Excel 报表邮件

---

## ⚙️ 前置准备

### 1. Python 环境
- 已安装 Python 3.8+
- 已配置环境变量（可在命令行运行 `python`）

### 2. SQLPathFinder
- 已安装 SQLPathFinder
- 确认安装路径：`C:/Program Files/SQLPathFinder/SQLPathFinder.exe`
- 如果路径不同，需要在 `config.yaml` 中修改

### 3. Outlook 邮件
- 已登录 Outlook 客户端（如使用 outlook 模式）
- 或者配置 SMTP 服务器（如使用 smtp 模式）

### 4. 依赖包安装
运行以下命令安装所需依赖：
```bash
python -m pip install -r prd_lot_automation\requirements.txt
```

或者直接双击 `运行工具.bat`，会自动检查并安装依赖。

---

## 📝 配置指南

### 步骤 1：准备 LOT 列表
编辑 `Lot info.txt` 文件，每行一个 LOT 编号：

```text
P540451CR
P540420CR
P540450CR
# 这是注释行，会被忽略
P540421CR
```

**支持特性**：
- ✅ 每行一个 LOT
- ✅ 支持 `#` 注释行
- ✅ 自动去重

### 步骤 2：截取 Run 按钮图片
**重要**：需要截取 SQLPathFinder 的 Run 按钮（⚡闪电图标）

详细步骤请参考：[assets/如何截取Run按钮.md](assets/如何截取Run按钮.md)

截图保存位置：
```
Test Data Auto analysis/assets/run_button.png
```

### 步骤 3：配置邮件信息
编辑 `prd_lot_automation/config.yaml`：

```yaml
email:
  mode: "outlook"  # 使用 Outlook 发送
  to:
    - "your.email@intel.com"  # 修改为您的邮箱
  cc: []
  subject_template: "[LOT日报] {date}（共{lot_count}个 LOT）"
```

**可选配置**：
- 添加多个收件人
- 添加抄送人
- 修改邮件主题模板

### 步骤 4：验证其他配置（可选）
查看 `prd_lot_automation/config.yaml` 中的路径配置：

```yaml
paths:
  lots_file: "../Lot info.txt"
  vg2_file: "../Get_Sort_or_Test_Unit_Results_HBASE_By_Lot.VG2"
  spf_executable: "C:/Program Files/SQLPathFinder/SQLPathFinder.exe"
  output_csv: "C:/Users/qibaiche/AppData/Local/Temp/SQLPathFinder_Temp/by_lot.csv"
```

确认路径是否正确，特别是：
- ✅ VG2 文件存在
- ✅ SQLPathFinder 可执行文件路径正确
- ✅ output_csv 路径可写入

---

## 🚀 运行方法

### 方法一：使用批处理脚本（推荐）
双击运行：
```
运行工具.bat
```

脚本会自动：
1. 检查 Python 环境
2. 安装/验证依赖包
3. 启动自动化工具
4. 显示运行日志

### 方法二：命令行运行
打开命令行（CMD 或 PowerShell），执行：

```bash
cd "Test Data Auto analysis"
python -m prd_lot_automation.main --config prd_lot_automation\config.yaml
```

### 方法三：指定自定义配置
```bash
python -m prd_lot_automation.main --config path/to/your/config.yaml
```

---

## 📊 输出说明

### 1. 日志文件
```
logs/prd_lot_automation.log
```

包含详细的运行日志：
- LOT 列表读取
- SQLPathFinder 连接状态
- CSV 文件监控进度
- 数据处理结果
- 邮件发送状态

### 2. Excel 报表
```
reports/LOT_Report_2025-11-17.xlsx
```

包含三个工作表：

#### Sheet 1: Functional_bin Pareto
- Functional_bin × DevRevStep 交叉统计表
- 数量（Quantity）和百分比（Percentage）
- 条件格式化：
  - 🔴 红色：>5%
  - 🟡 黄色：2-5%
  - 🟢 绿色：≤2%

#### Sheet 2: Details
- 完整的原始数据明细

#### Sheet 3: Exceptions
- 异常数据记录（如缺失字段等）

### 3. 邮件通知
自动发送邮件，包含：
- 📧 主题：`[LOT日报] 2025-11-17（共8个 LOT）`
- 📎 附件：Excel 报表
- 📝 正文摘要：
  - LOT 总数
  - Top3 Functional Bin
  - 异常记录数
  - Grand Total 数量

---

## ❓ 常见问题

### Q1: 找不到 Run 按钮
**原因**：图像识别失败

**解决方案**：
1. 确认 `assets/run_button.png` 存在且清晰
2. 重新截取按钮图片（参考 [截图指南](assets/如何截取Run按钮.md)）
3. 或者配置 AutomationId（需要使用 Inspect.exe 工具）：
   ```yaml
   ui:
     run_button_automation_id: "YourButtonId"
   ```

### Q2: 无法连接到 SQLPathFinder
**原因**：窗口标题不匹配或启动超时

**解决方案**：
1. 检查 SQLPathFinder 是否正常启动
2. 确认窗口标题是否为 "SQLPathFinder"
3. 增加超时时间：
   ```yaml
   timeouts:
     spf_launch: 120  # 改为 120 秒
   ```

### Q3: CSV 文件读取为空
**原因**：输出路径不正确或权限不足

**解决方案**：
1. 手动运行一次 VG2，查看 CSV 实际输出位置
2. 在 `config.yaml` 中更新 `output_csv` 路径
3. 确认该路径有写入权限

### Q4: 邮件发送失败
**原因**：Outlook 未登录或 SMTP 配置错误

**解决方案（Outlook 模式）**：
1. 确认 Outlook 已登录
2. 首次运行时，Outlook 可能会弹出权限确认，请点击"允许"

**解决方案（SMTP 模式）**：
1. 在 `config.yaml` 中配置 SMTP：
   ```yaml
   email:
     mode: "smtp"
     smtp:
       host: "smtp.intel.com"
       port: 587
       username: "your.username"
       password: "your.password"
       use_tls: true
   ```

### Q5: 数据处理出错
**错误示例**：`缺少列：['Lot', 'Functional_bin']`

**解决方案**：
1. 检查 CSV 文件的列名
2. 在 `config.yaml` 中更新字段映射：
   ```yaml
   fields:
     lot: "实际列名1"
     functional_bin: "实际列名2"
     devrevstep: "实际列名3"
     visual_id: "实际列名4"
   ```

### Q6: 程序运行时间过长
**原因**：LOT 数量过多或网络较慢

**解决方案**：
1. 启用批处理功能，分批执行：
   ```yaml
   processing:
     max_lots_per_batch: 10  # 每批最多 10 个 LOT
   ```
2. 增加总超时时间：
   ```yaml
   timeouts:
     overall_timeout: 1800  # 30 分钟
   ```

---

## 📞 技术支持

如遇到其他问题，请检查：
1. 📄 日志文件：`logs/prd_lot_automation.log`
2. 📖 代码文档：`prd_lot_automation/README.md`

---

## 📌 注意事项

⚠️ **重要提示**：
1. 运行期间不要操作 SQLPathFinder 窗口
2. 确保系统不会自动锁屏或休眠
3. 首次运行建议使用少量 LOT 测试
4. 定期检查 `logs` 和 `reports` 文件夹大小，清理旧文件

✅ **最佳实践**：
- 每天固定时间运行（可配合 Windows 任务计划）
- 保留最近 7 天的日志和报表
- 定期备份配置文件

---

**版本**：v1.0  
**最后更新**：2025-11-17


