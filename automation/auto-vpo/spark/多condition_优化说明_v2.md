# å¤š Condition ä¼˜åŒ–è¯´æ˜ (v2)

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
1. **ä»ç¬¬3ä¸ªconditionå¼€å§‹å‡ºç°é—®é¢˜**ï¼šå‰ä¸¤ä¸ªé€‰æ‹©æ²¡é—®é¢˜ï¼Œç¬¬3ä¸ªèµ·é€‰æ‹©å¤±è´¥
2. **ä¸€ç›´åœ¨åŠ condition**ï¼šå¾ªç¯ç‚¹å‡»"Add new condition"ï¼Œä½†ä¸å¡«å€¼
3. **é¡µé¢æ²¡æœ‰æ»šåŠ¨**ï¼šå°çª—å£å†…çš„é¡µé¢æ²¡æœ‰æ»šåŠ¨åˆ°æ–°åŒºå—

## æ ¹æœ¬åŸå› 

1. **æ–°åŒºå—æ¸²æŸ“æ…¢**ï¼šç‚¹å‡»"Add new condition"åï¼Œæ–°åŒºå—çš„DOMéœ€è¦æ—¶é—´æ¸²æŸ“
2. **æœªæ»šåŠ¨åˆ°æ–°åŒºå—**ï¼šæ–°åŒºå—åœ¨é¡µé¢åº•éƒ¨ï¼Œä½†æŸ¥æ‰¾æ—¶æ²¡æœ‰æ»šåŠ¨ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°
3. **ç­‰å¾…æ—¶é—´ä¸è¶³**ï¼šåŸæ¥åªç­‰å¾…1-2ç§’ï¼Œå¯¹äºå¤æ‚çš„Angular Materialç»„ä»¶æ¥è¯´ä¸å¤Ÿ
4. **æŸ¥æ‰¾é€»è¾‘é—®é¢˜**ï¼šæ¯æ¬¡æŸ¥æ‰¾æŠ¬å¤´è¡Œæ—¶ï¼Œæ²¡æœ‰å…ˆæ»šåŠ¨åˆ°åº•éƒ¨ï¼Œå¯èƒ½é—æ¼æ–°åŒºå—

---

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. **ä¼˜åŒ– `_find_operation_headers()` æ–¹æ³•**

#### æ–°å¢å‚æ•°ï¼š
```python
def _find_operation_headers(self, scroll_to_bottom: bool = True):
```

#### æ–°å¢åŠŸèƒ½ï¼š
- **è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨**ï¼šæŸ¥æ‰¾å‰å…ˆæ»šåŠ¨Flowå®¹å™¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æ‰€æœ‰åŒºå—éƒ½åŠ è½½å‡ºæ¥
- **æ›´è¯¦ç»†çš„æ—¥å¿—**ï¼šè®°å½•æ‰¾åˆ°çš„æ¯ä¸ªæŠ¬å¤´è¡Œçš„è¯¦ç»†ä¿¡æ¯
- **æ›´ç²¾ç¡®çš„è¿‡æ»¤**ï¼šæ’é™¤"Continue with"ã€"All Units"ã€"Additional Attributes"ç­‰å¹²æ‰°è¡Œ

#### æ ¸å¿ƒé€»è¾‘ï¼š
```python
# 1. æ»šåŠ¨åˆ°Flowå®¹å™¨åº•éƒ¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
if scroll_to_bottom:
    flow_container = driver.find_element(By.XPATH, "//mat-drawer-content")
    driver.execute_script("arguments[0].scrollTop = arguments[0].scrollHeight;", flow_container)
    time.sleep(0.5)

# 2. æŸ¥æ‰¾æ‰€æœ‰åŒ…å«2ä¸ªmat-select-arrowçš„å…ƒç´ 
all_elements = driver.find_elements(By.XPATH, "//*[.//div[contains(@class,'mat-select-arrow')]]")

# 3. è¿‡æ»¤ï¼šæ­£å¥½2ä¸ªç®­å¤´ï¼Œæ’é™¤å¹²æ‰°è¡Œï¼Œå¿…é¡»å¯è§
for elem in all_elements:
    arrows = elem.find_elements(By.CSS_SELECTOR, "div.mat-select-arrow")
    if len(arrows) == 2:  # æ­£å¥½2ä¸ªï¼šOperation + EngID
        if "Continue with" not in elem.text and "All Units" not in elem.text:
            operation_headers.append(elem)
```

---

### 2. **ä¼˜åŒ– `_click_add_new_condition()` æ–¹æ³•**

#### å¢åŠ ç­‰å¾…æ—¶é—´ï¼š
- **ç‚¹å‡»å‰ç­‰å¾…**ï¼š1ç§’
- **ç‚¹å‡»åç­‰å¾…**ï¼š3ç§’ï¼ˆä»åŸæ¥çš„2ç§’å¢åŠ åˆ°3ç§’ï¼‰
- **æ»šåŠ¨åç­‰å¾…**ï¼š1ç§’

#### å¢åŠ éªŒè¯é€»è¾‘ï¼š
```python
# ç‚¹å‡»å‰è®°å½•å½“å‰åŒºå—æ•°é‡
current_count = len(operation_headers)

# ç‚¹å‡»æŒ‰é’®
add_btn.click()

# ç­‰å¾…3ç§’
time.sleep(3.0)

# æ»šåŠ¨åˆ°åº•éƒ¨
flow_container.scrollTop = flow_container.scrollHeight
time.sleep(1.0)

# éªŒè¯æ–°åŒºå—æ˜¯å¦æ·»åŠ 
new_headers = _find_operation_headers(scroll_to_bottom=True)
new_count = len(new_headers)

if new_count > current_count:
    LOGGER.info(f"âœ… æˆåŠŸæ·»åŠ ï¼ˆä» {current_count} å¢åŠ åˆ° {new_count}ï¼‰")
else:
    # å†ç­‰2ç§’é‡è¯•
    time.sleep(2.0)
    retry_headers = _find_operation_headers(scroll_to_bottom=True)
    if len(retry_headers) > current_count:
        LOGGER.info(f"âœ… ç¬¬äºŒæ¬¡æ£€æŸ¥æˆåŠŸ")
    else:
        LOGGER.error(f"âŒ æ–°åŒºå—æœªæ·»åŠ ")
        return False
```

#### ç®€åŒ–æŒ‰é’®æŸ¥æ‰¾ï¼š
- **ä¼˜å…ˆå…¨å±€æŸ¥æ‰¾**ï¼šæŸ¥æ‰¾æ‰€æœ‰"Add new condition"ï¼Œå–æœ€åä¸€ä¸ªå¯è§çš„ï¼ˆæœ€ç®€å•å¯é ï¼‰
- **å¤‡ç”¨IDæŸ¥æ‰¾**ï¼š`addNewCondition`

---

### 3. **ä¼˜åŒ– `_select_operation()` æ–¹æ³•**

#### å¢åŠ è¯¦ç»†æ—¥å¿—ï¼š
```python
LOGGER.info(f"=" * 60)
LOGGER.info(f"å¼€å§‹é€‰æ‹©Operation: {operation} (ç¬¬ {condition_index + 1} ä¸ªåŒºå—)")
LOGGER.info(f"=" * 60)
```

#### å¢åŠ å®¹å™¨å†…æ»šåŠ¨ï¼š
```python
# åœ¨Flowå®¹å™¨å†…æ»šåŠ¨åˆ°æŠ¬å¤´è¡Œä½ç½®
flow_container = driver.find_element(By.XPATH, "//mat-drawer-content")
header_location = header.location
target_scroll = header_location['y'] - 200  # ä¸Šæ–¹ç•™200pxä½™é‡
driver.execute_script(f"arguments[0].scrollTop = {target_scroll};", flow_container)
```

#### å¢åŠ é‡è¯•æœºåˆ¶ï¼š
```python
if len(operation_headers) <= condition_index:
    LOGGER.error(f"âŒ åªæ‰¾åˆ° {len(operation_headers)} ä¸ªæŠ¬å¤´è¡Œ")
    # ç­‰å¾…2ç§’åé‡è¯•
    time.sleep(2.0)
    operation_headers = _find_operation_headers(scroll_to_bottom=True)
    if len(operation_headers) <= condition_index:
        LOGGER.error(f"âŒ é‡è¯•åä»ç„¶å¤±è´¥")
        return False
```

---

### 4. **ä¼˜åŒ– `_select_eng_id()` æ–¹æ³•**

ä¸ `_select_operation()` ç±»ä¼¼çš„ä¼˜åŒ–ï¼š
- è¯¦ç»†æ—¥å¿—
- å®¹å™¨å†…æ»šåŠ¨
- é‡è¯•æœºåˆ¶
- æ‰¾ç¬¬2ä¸ªç®­å¤´ï¼ˆEngIDï¼‰

---

### 5. **ä¼˜åŒ– `test_spark.py` ç­‰å¾…æ—¶é—´**

```python
# ç‚¹å‡»Add new conditionå
if not submitter._click_add_new_condition():
    print("âŒ å¤±è´¥\n")
    input()
    return
print("âœ…\n")

# ç­‰å¾…æ–°åŒºå—æ¸²æŸ“ï¼ˆä»1ç§’å¢åŠ åˆ°2ç§’ï¼‰
print(f"ç­‰å¾…æ–°åŒºå—æ¸²æŸ“...")
time.sleep(2.0)
```

---

## å…³é”®æ”¹è¿›

### 1. **è‡ªåŠ¨æ»šåŠ¨**
- æ¯æ¬¡æŸ¥æ‰¾æŠ¬å¤´è¡Œå‰ï¼Œå…ˆæ»šåŠ¨åˆ°Flowå®¹å™¨åº•éƒ¨
- æ¯æ¬¡é€‰æ‹©Operation/EngIDå‰ï¼Œæ»šåŠ¨åˆ°å¯¹åº”æŠ¬å¤´è¡Œä½ç½®
- åœ¨Flowå®¹å™¨å†…æ»šåŠ¨ï¼Œè€Œä¸æ˜¯æ•´ä¸ªé¡µé¢æ»šåŠ¨

### 2. **æ›´é•¿ç­‰å¾…**
- ç‚¹å‡»"Add new condition"åç­‰å¾…3ç§’ï¼ˆè€Œä¸æ˜¯2ç§’ï¼‰
- æ»šåŠ¨åé¢å¤–ç­‰å¾…1ç§’
- å¦‚æœç¬¬ä¸€æ¬¡æŸ¥æ‰¾å¤±è´¥ï¼Œç­‰å¾…2ç§’åé‡è¯•

### 3. **æ›´è¯¦ç»†æ—¥å¿—**
- è®°å½•æ‰¾åˆ°çš„æ¯ä¸ªæŠ¬å¤´è¡Œçš„å†…å®¹
- è®°å½•æŸ¥æ‰¾ã€æ»šåŠ¨ã€ç‚¹å‡»æ¯ä¸€æ­¥çš„ç»“æœ
- ä½¿ç”¨`=====`åˆ†éš”ä¸åŒæ“ä½œï¼Œä¾¿äºé˜…è¯»

### 4. **æ›´å¯é éªŒè¯**
- ç‚¹å‡»"Add new condition"åï¼ŒéªŒè¯åŒºå—æ•°é‡æ˜¯å¦å¢åŠ 
- å¦‚æœæœªå¢åŠ ï¼Œç­‰å¾…2ç§’åé‡è¯•éªŒè¯
- åªæœ‰ç¡®è®¤æ–°åŒºå—å·²æ·»åŠ ï¼Œæ‰è¿”å›True

---

## å·¥ä½œæµç¨‹ï¼ˆæ”¹è¿›åï¼‰

```python
# ç¬¬1ä¸ªconditionï¼ˆä½¿ç”¨å·²æœ‰åŒºå—ï¼‰
_select_operation("6248", condition_index=0)
_select_eng_id("AE", condition_index=0)

# ç¬¬2ä¸ªcondition
_click_add_new_condition()
  â†’ è®°å½•å½“å‰åŒºå—æ•°ï¼š1
  â†’ ç‚¹å‡»æŒ‰é’®
  â†’ ç­‰å¾…3ç§’
  â†’ æ»šåŠ¨åˆ°åº•éƒ¨
  â†’ éªŒè¯åŒºå—æ•°ï¼š2ï¼ˆæˆåŠŸï¼‰
time.sleep(2.0)  # é¢å¤–ç­‰å¾…
_select_operation("5248", condition_index=1)
  â†’ æŸ¥æ‰¾æ‰€æœ‰æŠ¬å¤´è¡Œï¼ˆæ»šåŠ¨åˆ°åº•éƒ¨ï¼‰
  â†’ å–ç¬¬2ä¸ªæŠ¬å¤´è¡Œ
  â†’ æ»šåŠ¨åˆ°æŠ¬å¤´è¡Œä½ç½®
  â†’ ç‚¹å‡»ç¬¬1ä¸ªç®­å¤´
_select_eng_id("AF", condition_index=1)
  â†’ æŸ¥æ‰¾æ‰€æœ‰æŠ¬å¤´è¡Œï¼ˆæ»šåŠ¨åˆ°åº•éƒ¨ï¼‰
  â†’ å–ç¬¬2ä¸ªæŠ¬å¤´è¡Œ
  â†’ æ»šåŠ¨åˆ°æŠ¬å¤´è¡Œä½ç½®
  â†’ ç‚¹å‡»ç¬¬2ä¸ªç®­å¤´

# ç¬¬3ä¸ªconditionï¼ˆä»¥æ­¤ç±»æ¨ï¼‰
...
```

---

## é¢„æœŸæ•ˆæœ

### é—®é¢˜ä¿®å¤ï¼š
1. âœ… **ç¬¬3+ä¸ªconditionä¸å†å¤±è´¥**ï¼šæ¯æ¬¡éƒ½æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æ‰¾åˆ°æ‰€æœ‰åŒºå—
2. âœ… **ä¸å†ä¸€ç›´åŠ condition**ï¼šæœ‰éªŒè¯æœºåˆ¶ï¼Œç¡®è®¤åŒºå—å·²æ·»åŠ æ‰ç»§ç»­
3. âœ… **é¡µé¢ä¼šè‡ªåŠ¨æ»šåŠ¨**ï¼šåœ¨Flowå®¹å™¨å†…è‡ªåŠ¨æ»šåŠ¨åˆ°å¯¹åº”ä½ç½®

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š
```
============================================================
å¼€å§‹é€‰æ‹©Operation: 6248 (ç¬¬ 3 ä¸ªåŒºå—)
============================================================
æŸ¥æ‰¾æ‰€æœ‰OperationæŠ¬å¤´è¡Œ...
æ‰¾åˆ° 15 ä¸ªåŒ…å«mat-select-arrowçš„å…ƒç´ 
âœ… æ‰¾åˆ°OperationæŠ¬å¤´è¡Œ #1: 6248 AE CLASSHOT
âœ… æ‰¾åˆ°OperationæŠ¬å¤´è¡Œ #2: 5248 AF CLASSHOT
âœ… æ‰¾åˆ°OperationæŠ¬å¤´è¡Œ #3: 5167 AG CLASSHOT
âœ… æ€»å…±æ‰¾åˆ° 3 ä¸ªOperationæŠ¬å¤´è¡Œ
âœ… å®šä½åˆ°ç¬¬ 3 ä¸ªOperationæŠ¬å¤´è¡Œ
   æŠ¬å¤´è¡Œå†…å®¹: 5167 AG CLASSHOT
âœ… å·²åœ¨Flowå®¹å™¨å†…æ»šåŠ¨åˆ°æŠ¬å¤´è¡Œä½ç½®ï¼ˆscrollTop=1200ï¼‰
åœ¨æŠ¬å¤´è¡Œå†…æ‰¾åˆ° 2 ä¸ªmat-select-arrow
âœ… æ‰¾åˆ°Operationç®­å¤´ï¼ˆç¬¬1ä¸ªï¼‰ï¼Œå‡†å¤‡ç‚¹å‡»
âœ… å·²ç‚¹å‡»Operationç®­å¤´ï¼ˆæ™®é€šç‚¹å‡»ï¼‰
âœ… mat-selecté¢æ¿å·²æ‰“å¼€
âœ… å·²é€‰æ‹©é€‰é¡¹: 5167
âœ…âœ…âœ… å·²æˆåŠŸé€‰æ‹©Operation: 5167 (ç¬¬ 3 ä¸ªåŒºå—)
```

---

## æµ‹è¯•å»ºè®®

1. **æµ‹è¯•5ä¸ªä»¥ä¸Šçš„condition**ï¼šç¡®ä¿æ»šåŠ¨å’ŒæŸ¥æ‰¾é€»è¾‘æ­£ç¡®
2. **è§‚å¯Ÿæ—¥å¿—è¾“å‡º**ï¼šç¡®è®¤æ¯æ¬¡éƒ½èƒ½æ‰¾åˆ°æ­£ç¡®æ•°é‡çš„æŠ¬å¤´è¡Œ
3. **è§‚å¯Ÿæµè§ˆå™¨**ï¼šåº”è¯¥èƒ½çœ‹åˆ°é¡µé¢è‡ªåŠ¨æ»šåŠ¨åˆ°æ­£ç¡®ä½ç½®

---

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

- âœ… `spark_submitter.py`
  - `_find_operation_headers()` - å¢åŠ æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œè¯¦ç»†æ—¥å¿—
  - `_click_add_new_condition()` - å¢åŠ ç­‰å¾…æ—¶é—´ï¼ŒéªŒè¯æœºåˆ¶
  - `_select_operation()` - å¢åŠ å®¹å™¨å†…æ»šåŠ¨ï¼Œé‡è¯•æœºåˆ¶ï¼Œè¯¦ç»†æ—¥å¿—
  - `_select_eng_id()` - å¢åŠ å®¹å™¨å†…æ»šåŠ¨ï¼Œé‡è¯•æœºåˆ¶ï¼Œè¯¦ç»†æ—¥å¿—

- âœ… `test_spark.py`
  - å¢åŠ æ¯æ¬¡æ·»åŠ conditionåçš„ç­‰å¾…æ—¶é—´ï¼ˆ1ç§’ â†’ 2ç§’ï¼‰

---

## ä¸‹ä¸€æ­¥

è¿è¡Œ `æµ‹è¯•Spark.bat`ï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡ºã€‚åº”è¯¥èƒ½çœ‹åˆ°ï¼š
- âœ… æ¯æ¬¡æŸ¥æ‰¾éƒ½èƒ½æ‰¾åˆ°æ­£ç¡®æ•°é‡çš„æŠ¬å¤´è¡Œ
- âœ… é¡µé¢ä¼šè‡ªåŠ¨æ»šåŠ¨åˆ°æ­£ç¡®ä½ç½®
- âœ… ä¸å†é‡å¤ç‚¹å‡»"Add new condition"
- âœ… æ‰€æœ‰conditionéƒ½èƒ½æˆåŠŸå¡«å†™

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œæ—¥å¿—ä¼šæ¸…æ™°æ˜¾ç¤ºæ˜¯å“ªä¸€æ­¥å¤±è´¥äº†ï¼ğŸš€

